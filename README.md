# Campaign Video Optimizer Pro - V2

スマートフォン広告キャンペーン入稿用に特化した、ブラウザ完結型の動画一括最適化ツールです。

## 🚀 実装済みの機能

- **FFmpeg.wasm 統合**: 外部サーバーを介さず、ブラウザ内で動画の再エンコードと画像抽出を実行。
- **1MB(1.5MB可変)厳守ロジック**: 動画の長さから目標ビットレートを動的に計算し、容量制限内に収めます。
- **サイズ超過時の自動再試行**: エンコード後のファイルサイズが2MB（絶対上限）を超えた場合、ビットレートを自動で30%下げて再エンコードを試みるロジックを実装。
- **3点サムネイル抽出**: 動画の開始(10%)、中間(50%)、終盤(85%)から自動で画像を切り出し。
- **スマホ最適化**: 横幅720px固定（アスペクト比維持）のリサイズ機能を搭載。
- **ZIP一括書き出し**: 最適化された動画とサムネイル画像をフォルダ構造を維持したままパッケージング。
- **詳細プレビュー**: 圧縮後の動画をダウンロード前にブラウザ上で確認できるビデオプレイヤー機能。
- **スマート黒コマ回避**: Canvas APIによるピクセル解析で「黒くないフレーム」を自動検知してサムネイルを抽出。

## 🏃 ローカル開発環境のセットアップ

```bash
# 依存関係のインストール
npm install

# 開発サーバーを起動
npm run dev

# ビルド
npm run build

# ビルド後のプレビュー
npm run preview
```

開発サーバー起動後、http://localhost:3000/ でアクセスできます。

**COOP/COEPヘッダー**: ローカル開発サーバーにはFFmpegマルチスレッド対応のためのヘッダーが設定されています。

## ⚠️ 技術的制限事項 (この環境特有の制約)

本アプリケーションはブラウザのWebAssembly上で動作しているため、以下の制限があります。

1. **Cross-Origin Isolation (COOP/COEP)**
   - ローカル開発サーバーではCOOP/COEPヘッダーが設定されており、`SharedArrayBuffer`が有効です。
   - 本番環境デプロイ時は、ホスティング先で以下のヘッダーを設定する必要があります:
     - `Cross-Origin-Opener-Policy: same-origin`
     - `Cross-Origin-Embedder-Policy: require-corp`
2. **エンコード負荷**
   - 長尺の動画や高解像度の動画は、ブラウザのCPUリソースを非常に多く消費します。処理中はブラウザが重くなる可能性があります。
3. **Worker Origin 制約**
   - ESM形式のWorkerロードがオリジン制約によりブロックされるため、本ツールでは **UMD形式の読み込み + 全コアファイルのBlob URL化** という特殊な回避策を用いてFFmpegを起動しています。

## 🛠 残りタスク / 今後の改善

- [x] ~~**スマート黒コマ回避**: ピクセル解析による「黒くないフレーム」の自動検知。~~
- [x] ~~**詳細プレビュー**: 圧縮後の動画をZIPダウンロード前にブラウザ上で確認できるプレイヤー。~~
- [ ] **GPU加速**: WebGPU等を利用した高速なデコード・エンコードの検討。
- [ ] **サーバーサイドフォールバック**: ユーザー端末のスペックが低い場合に、クラウド側で処理を代行するハイブリッド構成。

## 📦 開発者向け情報

- **Core Engine**: `@ffmpeg/ffmpeg` (v0.12.10)
- **Runtime**: React 19
- **Build Tool**: Vite 6
- **Styling**: Tailwind CSS (CDN)
